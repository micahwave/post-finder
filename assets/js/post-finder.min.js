/*! Post Finder - v0.2
 * 
 * Copyright (c) 2017; */
!function(a,b,c){"use strict";var d={};b.postFinder=function(a,c){var e,f,g,h;f="mainTemplate"in d?d.mainTemplate:d.mainTemplate=b("#tmpl-post-finder-main").html(),g="itemTemplate"in d?d.itemTemplate:d.itemTemplate=b("#tmpl-post-finder-item").html(),e={template:f,fieldSelector:"input[type=hidden]",typesfieldSelector:"input#types[type=hidden]",selectSelector:"select",listSelector:".list",searchSelector:".search",resultsSelector:".results",querySelector:"input[type=text]",nonceSelector:"#post_finder_nonce"};var i=this;i.settings={};var j=b(a),a=a;i.init=function(){i.settings=b.extend({},e,c),i.$field=j.find(i.settings.fieldSelector),i.$typefield=j.find(i.settings.typesfieldSelector),i.$select=j.find(i.settings.selectSelector),i.$list=j.find(i.settings.listSelector),i.$search=j.find(i.settings.searchSelector),i.$results=i.$search.find(i.settings.resultsSelector),i.$query=i.$search.find(i.settings.querySelector),i.nonce=b(i.settings.nonceSelector).val(),i.$select.on("change",function(a){i.add_item(b(this).val(),b("option:selected",this).text(),b("option:selected",this).data("permalink"))}),i.$search.on("click",".button",function(a){a.preventDefault(),i.search(a)}),i.$search.on("keypress",'input[type="text"]',function(a){13===a.which&&(a.preventDefault(),i.search(a))}),i.$list.sortable({placeholder:"placeholder",update:function(a,b){i.serialize()}}),i.$list.on("click",".delete",function(a){a.preventDefault(),i.remove_item(b(this).closest("li").data("id"))}),i.$results.on("click",".add",function(a){a.preventDefault(),h=b(this).closest("li"),i.add_item(h.data("id"),h.find("span").text(),h.data("permalink"))}),i.$list.on("keypress","li input",function(a){13==a.which&&(a.preventDefault(),b(this).trigger("blur"))}),i.$list.on("blur","li input",function(a){i.move_item(b(this).closest("li"),b(this).val())})},i.move_item=function(a,b){var c,d=i.$list.find("li"),e=d.length;return b>e||b<1?(alert("Please pick a position between 1 and "+e),!1):b-1!=a.index()&&(c=a.clone(),1==b?i.$list.prepend(c):b>1&&b<e?i.$list.find("li").eq(b-1).before(c):b==e&&i.$list.append(c),a.remove(),void i.serialize())},i.add_item=function(a,b,c){var d=_.template(i.settings.template);if(0!=a){if(i.$list.find("li").length>=j.data("limit"))return void alert(POST_FINDER_CONFIG.max_number_allowed);if(i.$list.find('li[data-id="'+a+'"]').length)return void alert(POST_FINDER_CONFIG.already_added);i.$list.append(d({id:a,title:b,edit_url:POST_FINDER_CONFIG.adminurl+"post.php?post="+a+"&action=edit",permalink:c,pos:i.$list.length+1})),i.$list.find(".notice").hide(),i.$select.find('option[value="'+a+'"]').remove(),i.serialize()}},i.remove_item=function(a){i.$list.find('li[data-id="'+a+'"]').remove(),i.serialize(),0==i.$list.find("li").length&&i.$list.find(".notice").show()},i.search=function(a){var c="",d=a.currentTarget.getAttribute("data-page")?+a.currentTarget.getAttribute("data-page"):1,e={action:"pf_search_posts",s:i.$query.val(),page:d,_ajax_nonce:i.nonce},f=d+1,h=_.template(g);e=b.extend(e,j.data("args")),i.$search.addClass("loading"),b.ajax(ajaxurl,{type:"POST",data:e,dataType:"json",success:function(a){if(void 0!==a.posts){if(a.posts.length>0){for(var b in a.posts)c+=h(a.posts[b]);10===a.posts.length&&(c+='<li class="next"><a href="#" class="button" data-page="'+f+'">'+POST_FINDER_CONFIG.next+"</a></li>")}else c="<li>"+POST_FINDER_CONFIG.nothing_found+"</li>";i.$search.removeClass("loading"),i.$results.html(c)}}})},i.serialize=function(){var a=[],c=[],d=1;i.$list.find("li").each(function(){b(this).find("input").val(d),a.push(b(this).data("id")),c.push(b(this).data("type")),d++}),i.$field.val(a.join(",")),i.$typefield.val(c.join(",")),b(document).trigger("updatePostfinder",{idField:i.$field,typeField:i.$typefield})},i.init()},b.fn.postFinder=function(a){return this.each(function(){if(c==b(this).data("postFinder")){var d=new b.postFinder(this,a);b(this).data("postFinder",d)}})}}(window,jQuery);